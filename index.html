<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Espresso Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        input[type="range"] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type="range"]::-webkit-slider-runnable-track { background: #1e293b; height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; background: #3b82f6; border-radius: 50%; margin-top: -7px; border: 2px solid #020617; }
        input { color: white !important; }
    </style>
</head>
<body>
    <!-- iOS 무음 모드 우회를 위한 히든 오디오 요소 -->
    <audio id="silent-audio" loop preload="auto" style="display:none;">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons({ attrs: { class: className, 'stroke-width': 2, width: size, height: size }, name: name });
            }, [name, size, className]);
            return <i data-lucide={name} className={className}></i>;
        };

        const App = () => {
            const [view, setView] = useState('list');
            const [showImportModal, setShowImportModal] = useState(false);
            const [toast, setToast] = useState(null);
            const [isMuted, setIsMuted] = useState(false);

            const [recipes, setRecipes] = useState([
                {
                    id: 1,
                    name: 'Classic Flair 58 Profile',
                    dose: 18,
                    yield: 36,
                    temp: 93,
                    steps: [
                        { name: 'Pre-infusion', duration: 10, pressure: 2, pressureEnd: 2 },
                        { name: 'Ramp Up', duration: 3, pressure: 2, pressureEnd: 9 },
                        { name: 'Main Extraction', duration: 20, pressure: 9, pressureEnd: 9 },
                        { name: 'Tapering', duration: 7, pressure: 9, pressureEnd: 6 }
                    ]
                }
            ]);
            const [selectedIdx, setSelectedIdx] = useState(0);
            const [editedRecipe, setEditedRecipe] = useState(null);

            const [status, setStatus] = useState('idle');
            const [countdown, setCountdown] = useState(5);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [activeStepIdx, setActiveStepIdx] = useState(0);
            
            const timerRef = useRef(null);
            const audioCtx = useRef(null);

            const currentRecipe = recipes[selectedIdx];

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            // TTS를 사용한 알림음 생성 (무음 모드 우회)
            const speak = (text, rate = 1.1) => {
                if (isMuted) return;
                try {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    const isEnglish = /[a-zA-Z]/.test(text);
                    utterance.lang = isEnglish ? 'en-US' : 'ko-KR';
                    utterance.pitch = 1.0;
                    utterance.rate = rate;
                    window.speechSynthesis.speak(utterance);
                } catch (e) {}
            };

            // 비프음 대용 TTS 알림 (무음 모드 대응)
            const playAlertSound = (type = 'short') => {
                if (isMuted) return;
                // "띵" 소리와 유사한 느낌을 주기 위해 짧고 높은 톤의 기호를 읽게 하거나
                // 아주 짧은 무음 뒤에 메시지를 출력하여 오디오 채널을 활성화합니다.
                if (type === 'short') {
                    speak("!", 2.0); // 느낌표는 보통 짧은 멈춤이나 아주 미세한 소리를 유발합니다.
                } else if (type === 'transition') {
                    speak("다음", 1.5);
                } else if (type === 'final') {
                    speak("추출 완료", 1.0);
                }
            };

            const initAudio = async () => {
                try {
                    const silentAudio = document.getElementById('silent-audio');
                    if (silentAudio) {
                        silentAudio.play().catch(() => {});
                    }
                    if (!audioCtx.current) {
                        audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    if (audioCtx.current.state === 'suspended') {
                        await audioCtx.current.resume();
                    }
                    // TTS 워밍업
                    speak("", 1.0);
                } catch (e) {}
            };

            const totalDuration = useMemo(() => 
                currentRecipe?.steps.reduce((acc, s) => acc + s.duration, 0) || 0
            , [currentRecipe]);

            const getStepAtTime = (time) => {
                let acc = 0;
                for (let i = 0; i < currentRecipe.steps.length; i++) {
                    acc += currentRecipe.steps[i].duration;
                    if (time < acc) return i;
                }
                return currentRecipe.steps.length - 1;
            };

            useEffect(() => {
                if (status === 'countdown') {
                    const interval = setInterval(() => {
                        setCountdown(prev => {
                            if (prev <= 1) {
                                setStatus('running');
                                playAlertSound('transition');
                                speak(currentRecipe.steps[0].name);
                                return 0;
                            }
                            playAlertSound('short');
                            return prev - 1;
                        });
                    }, 1000);
                    return () => clearInterval(interval);
                }
                if (status === 'running') {
                    const start = Date.now() - (elapsedTime * 1000);
                    timerRef.current = setInterval(() => {
                        const now = (Date.now() - start) / 1000;
                        const stepIdx = getStepAtTime(now);
                        
                        if (stepIdx !== activeStepIdx && stepIdx < currentRecipe.steps.length) {
                            setActiveStepIdx(stepIdx);
                            playAlertSound('transition');
                            speak(currentRecipe.steps[stepIdx].name);
                        }
                        
                        if (now >= totalDuration) {
                            setElapsedTime(totalDuration);
                            setStatus('finished');
                            playAlertSound('final');
                            clearInterval(timerRef.current);
                        } else {
                            setElapsedTime(now);
                        }
                    }, 50);
                    return () => clearInterval(timerRef.current);
                }
            }, [status, activeStepIdx, currentRecipe, elapsedTime, totalDuration]);

            const ProgressGraph = ({ recipe, time, showIndicator = true }) => {
                if (!recipe) return null;
                const recipeTotal = recipe.steps.reduce((acc, s) => acc + s.duration, 0);
                let currentX = 20;
                const points = [];
                points.push(`20,${90 - (recipe.steps[0].pressure / 11) * 80}`);
                recipe.steps.forEach(s => {
                    const stepW = (s.duration / recipeTotal) * 360;
                    const endY = 90 - ((s.pressureEnd || s.pressure) / 11) * 80;
                    points.push(`${currentX + stepW},${endY}`);
                    currentX += stepW;
                });
                const progressX = 20 + (time / recipeTotal) * 360;
                return (
                    <div className="w-full bg-slate-900/50 rounded-2xl p-2 border border-white/5">
                        <svg viewBox="0 0 400 100" className="w-full h-auto">
                            {[0, 2, 4, 6, 8, 10].map(v => <line key={v} x1="20" y1={90-(v/11)*80} x2="380" y2={90-(v/11)*80} stroke="#1e293b" strokeWidth="1" />)}
                            <polyline fill="none" stroke="#3b82f6" strokeWidth="3" points={points.join(' ')} strokeLinejoin="round" />
                            {showIndicator && time > 0 && <line x1={progressX} y1="10" x2={progressX} y2="90" stroke="#f43f5e" strokeWidth="2" strokeDasharray="4" />}
                        </svg>
                    </div>
                );
            };

            if (view === 'list') {
                return (
                    <div className="min-h-screen safe-top safe-bottom px-6 py-8 flex flex-col items-center">
                        <div className="w-full max-w-md">
                            <div className="flex justify-between items-center mb-10">
                                <h1 className="text-3xl font-black bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent italic">FLAIR 58</h1>
                                <button onClick={() => {
                                    const r = { id: Date.now(), name: 'New Recipe', dose: 18, yield: 36, temp: 93, steps: [{ name: 'Extraction', duration: 30, pressure: 9, pressureEnd: 9 }] };
                                    setRecipes([...recipes, r]);
                                    setSelectedIdx(recipes.length);
                                    setEditedRecipe(r);
                                    setView('detail');
                                }} className="p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-900/20 text-white"><Icon name="plus" /></button>
                            </div>
                            <div className="space-y-4">
                                {recipes.map((r, i) => (
                                    <div key={r.id} onClick={() => { setSelectedIdx(i); setEditedRecipe({...r}); setView('detail'); }} className="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-6 active:scale-95 transition-transform">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h2 className="text-xl font-bold mb-2 text-white">{r.name}</h2>
                                                <div className="flex gap-4 text-xs font-bold text-slate-400 uppercase tracking-widest">
                                                    <span className="bg-slate-800 px-2 py-0.5 rounded text-white">{r.dose}g</span>
                                                    <span className="bg-blue-900/30 px-2 py-0.5 rounded text-blue-400">{r.yield}g</span>
                                                    <span className="bg-rose-900/30 px-2 py-0.5 rounded text-rose-400">{r.temp}°C</span>
                                                </div>
                                            </div>
                                            <Icon name="chevron-right" size={20} className="text-slate-600" />
                                        </div>
                                        <ProgressGraph recipe={r} time={0} showIndicator={false} />
                                    </div>
                                ))}
                            </div>
                        </div>
                        {toast && <div className="fixed bottom-10 bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-2xl z-50">{toast}</div>}
                    </div>
                );
            }

            if (view === 'detail') {
                return (
                    <div className="min-h-screen safe-top safe-bottom px-6 py-8 flex flex-col items-center text-white">
                        <div className="w-full max-w-md pb-40">
                            <div className="flex justify-between items-center mb-6">
                                <button onClick={() => setView('list')} className="p-2 text-slate-400"><Icon name="chevron-left" size={32}/></button>
                                <div className="flex gap-2">
                                    <button onClick={() => setIsMuted(!isMuted)} className="p-3 bg-slate-900 rounded-xl border border-slate-800"><Icon name={isMuted ? "volume-x" : "volume-2"} size={20}/></button>
                                    <button onClick={() => { if(recipes.length > 1) { setRecipes(recipes.filter((_, i) => i !== selectedIdx)); setView('list'); } }} className="p-3 bg-rose-500/10 text-rose-500 rounded-xl"><Icon name="trash-2" size={20}/></button>
                                </div>
                            </div>
                            <input className="w-full bg-transparent text-3xl font-black mb-8 focus:outline-none text-white border-b border-white/10 pb-2" value={editedRecipe.name} onChange={e => setEditedRecipe({...editedRecipe, name: e.target.value})} />
                            <div className="grid grid-cols-3 gap-3 mb-8">
                                <div className="bg-slate-900 p-4 rounded-3xl border border-slate-800 text-center">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Dose</div>
                                    <input type="number" className="w-full bg-transparent font-mono text-2xl font-black text-white text-center" value={editedRecipe.dose} onChange={e => setEditedRecipe({...editedRecipe, dose: Number(e.target.value)})} />
                                </div>
                                <div className="bg-slate-900 p-4 rounded-3xl border border-slate-800 text-center">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Yield</div>
                                    <input type="number" className="w-full bg-transparent font-mono text-2xl font-black text-blue-400 text-center" value={editedRecipe.yield} onChange={e => setEditedRecipe({...editedRecipe, yield: Number(e.target.value)})} />
                                </div>
                                <div className="bg-slate-900 p-4 rounded-3xl border border-slate-800 text-center">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Temp</div>
                                    <input type="number" className="w-full bg-transparent font-mono text-2xl font-black text-rose-400 text-center" value={editedRecipe.temp} onChange={e => setEditedRecipe({...editedRecipe, temp: Number(e.target.value)})} />
                                </div>
                            </div>
                            <div className="mb-8"><ProgressGraph recipe={editedRecipe} time={0} showIndicator={false} /></div>
                            <div className="space-y-4">
                                {editedRecipe.steps.map((s, idx) => (
                                    <div key={idx} className="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                                        <div className="flex gap-2 mb-4">
                                            <input className="flex-1 bg-slate-800 rounded-xl px-4 py-3 text-sm font-bold text-white focus:ring-1 ring-blue-500" value={s.name} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].name = e.target.value; setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            <div className="flex items-center gap-2 bg-slate-800 px-3 rounded-xl">
                                                <input type="number" className="w-8 bg-transparent text-center font-mono text-blue-400 font-bold" value={s.duration} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].duration = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                                <span className="text-[10px] text-slate-500 font-bold">S</span>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <div>
                                                <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1"><span>START PRESSURE</span><span>{s.pressure} BAR</span></div>
                                                <input type="range" min="0" max="11" step="0.5" className="w-full" value={s.pressure} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].pressure = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            </div>
                                            <div>
                                                <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1"><span>END PRESSURE</span><span>{s.pressureEnd || s.pressure} BAR</span></div>
                                                <input type="range" min="0" max="11" step="0.5" className="w-full" value={s.pressureEnd || s.pressure} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].pressureEnd = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => setEditedRecipe({...editedRecipe, steps: [...editedRecipe.steps, { name: 'New Step', duration: 10, pressure: 6, pressureEnd: 6 }]})} className="w-full py-5 border-2 border-dashed border-slate-800 rounded-3xl text-slate-500 font-bold">+ 단계 추가</button>
                            </div>
                            <div className="fixed bottom-0 left-0 w-full p-6 safe-bottom bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent z-40">
                                <div className="max-w-md mx-auto flex gap-3">
                                    <button onClick={() => { setRecipes(prev => { const n = [...prev]; n[selectedIdx] = editedRecipe; return n; }); setView('list'); showToast("저장되었습니다."); }} className="flex-1 py-5 bg-slate-800 rounded-[2rem] font-bold text-white shadow-xl active:scale-95 transition-transform">저장</button>
                                    <button onClick={async () => { 
                                        await initAudio(); 
                                        setElapsedTime(0); 
                                        setActiveStepIdx(0); 
                                        setCountdown(5); 
                                        setStatus('countdown'); 
                                        setView('active'); 
                                    }} className="flex-[2] py-5 bg-blue-600 rounded-[2rem] font-black text-xl text-white shadow-2xl active:scale-95 transition-transform">추출 시작</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const activeStep = currentRecipe.steps[activeStepIdx];

            return (
                <div className="min-h-screen safe-top safe-bottom p-8 flex flex-col items-center overflow-hidden text-white bg-slate-950">
                    <div className="w-full max-w-md h-full flex flex-col">
                        <header className="flex justify-between items-start mb-8">
                            <div className="space-y-2">
                                <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div><h2 className="text-sm font-bold uppercase text-slate-300">{currentRecipe.name}</h2></div>
                                <div className="flex gap-4 text-xs font-mono text-slate-400 font-black"><span>{currentRecipe.dose}g</span><span>{currentRecipe.yield}g</span><span>{currentRecipe.temp}°C</span></div>
                            </div>
                            <button onClick={() => { setStatus('idle'); setElapsedTime(0); setView('list'); }} className="p-3 bg-slate-900 rounded-full text-slate-400"><Icon name="rotate-ccw" size={18} /></button>
                        </header>
                        <main className="flex-1 flex flex-col justify-center">
                            {status === 'countdown' ? (
                                <div className="text-center">
                                    <div className="text-[12rem] font-black text-blue-500 leading-none drop-shadow-[0_0_30px_rgba(59,130,246,0.3)]">{countdown}</div>
                                    <div className="text-xl font-bold tracking-[0.5em] text-slate-600 uppercase mt-4">Get Ready</div>
                                </div>
                            ) : (
                                <div className="space-y-12">
                                    <div className="text-center">
                                        <div className="text-xl font-bold text-slate-400 uppercase tracking-widest mb-4 bg-slate-900/50 py-2 rounded-full border border-white/5">{activeStep?.name}</div>
                                        <div className="flex items-center justify-center gap-3">
                                            <div className="text-[8rem] font-black leading-none text-white tracking-tighter">{activeStep?.pressure}</div>
                                            {activeStep?.pressureEnd && activeStep.pressureEnd !== activeStep.pressure && (
                                                <div className="flex items-center gap-3"><span className="text-4xl text-slate-600">→</span><span className="text-[8rem] font-black text-white tracking-tighter">{activeStep.pressureEnd}</span></div>
                                            )}
                                            <div className="text-2xl font-black text-cyan-500 mt-12 ml-2">BAR</div>
                                        </div>
                                    </div>
                                    <div className="space-y-8">
                                        <ProgressGraph recipe={currentRecipe} time={elapsedTime} />
                                        <div className="flex justify-between items-end px-2">
                                            <div className="text-7xl font-mono font-bold text-white tabular-nums">{elapsedTime.toFixed(1)}<span className="text-2xl text-slate-600 ml-1">s</span></div>
                                            <div className="text-right"><div className="text-[10px] font-black text-slate-500 uppercase mb-1">Remaining</div><div className="text-3xl font-mono text-slate-300 tabular-nums">{(totalDuration - elapsedTime).toFixed(1)}s</div></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                        <footer className="mt-12 py-8">
                            {status === 'finished' ? (
                                <button onClick={() => { setStatus('idle'); setElapsedTime(0); setView('list'); }} className="w-full py-6 bg-blue-600 rounded-[2.5rem] text-2xl font-black text-white shadow-2xl active:scale-95 transition-transform">추출 완료 - 돌아가기</button>
                            ) : (
                                <div className="grid grid-cols-4 gap-2">
                                    {currentRecipe.steps.map((_, i) => (
                                        <div key={i} className={`h-1.5 rounded-full transition-all duration-300 ${i === activeStepIdx ? 'bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]' : i < activeStepIdx ? 'bg-slate-700' : 'bg-slate-900'}`} />
                                    ))}
                                </div>
                            )}
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
