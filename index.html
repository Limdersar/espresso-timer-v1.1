<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Espresso Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        input[type="range"] { -webkit-appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type="range"]::-webkit-slider-runnable-track { background: #1e293b; height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; background: #3b82f6; border-radius: 50%; margin-top: -7px; border: 2px solid #020617; }
        input { color: white !important; }
        
        .pressure-container {
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <audio id="silent-audio" preload="auto" style="display:none;">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const spanRef = useRef(null);
            useEffect(() => {
                if (spanRef.current && window.lucide) {
                    spanRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({
                        root: spanRef.current,
                        attrs: { width: size, height: size, 'stroke-width': 2 }
                    });
                }
            }, [name, size]);
            return <span ref={spanRef} className={`inline-flex items-center justify-center ${className}`}></span>;
        };

        const defaultRecipe = {
            name: 'Classic Flair 58 Profile', dose: 18, yield: 36, temp: 93,
            steps: [
                { name: 'Pre-infusion', duration: 10, pressure: 2, pressureEnd: 2 },
                { name: 'Ramp Up', duration: 3, pressure: 2, pressureEnd: 9 },
                { name: 'Main Extraction', duration: 20, pressure: 9, pressureEnd: 9 },
                { name: 'Tapering', duration: 7, pressure: 9, pressureEnd: 6 }
            ]
        };

        const App = () => {
            const [view, setView] = useState('list');
            const [toast, setToast] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            
            // State initialization (Always render UI immediately)
            const [recipes, setRecipes] = useState([defaultRecipe]);
            const [selectedIdx, setSelectedIdx] = useState(0);
            const [editedRecipe, setEditedRecipe] = useState(null);
            
            const [status, setStatus] = useState('idle');
            const [countdown, setCountdown] = useState(5);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [activeStepIdx, setActiveStepIdx] = useState(0);

            // Cloud Data States
            const [fbOps, setFbOps] = useState(null);
            const [user, setUser] = useState(null);

            // Import Modal States
            const [showImportModal, setShowImportModal] = useState(false);
            const [importCode, setImportCode] = useState('');
            
            const timerRef = useRef(null);
            const audioCtx = useRef(null);
            const voicesRef = useRef([]);
            const lastSpokenSec = useRef(-1);

            // Dynamic Firebase Initialization (Non-blocking)
            useEffect(() => {
                let unsubscribeAuth = null;
                let unsubscribeSnapshot = null;

                const initFirebase = async () => {
                    try {
                        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                        const { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                        
                        if(typeof __firebase_config === 'undefined') return;

                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'espresso-timer-default';

                        setFbOps({ db, appId, doc, collection, addDoc, updateDoc, deleteDoc });

                        const initAuth = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        };
                        await initAuth();

                        unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            if (u) {
                                const q = collection(db, 'artifacts', appId, 'users', u.uid, 'recipes');
                                unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                                    const loaded = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                                    if (loaded.length > 0) {
                                        setRecipes(loaded);
                                    } else {
                                        // Save default recipe silently
                                        addDoc(q, defaultRecipe);
                                    }
                                }, (err) => console.error("Sync error, using local data", err));
                            }
                        });
                    } catch (e) {
                        console.log("Running in local mode without cloud sync.");
                    }
                };
                
                initFirebase();

                return () => {
                    if (unsubscribeAuth) unsubscribeAuth();
                    if (unsubscribeSnapshot) unsubscribeSnapshot();
                };
            }, []);

            useEffect(() => {
                const loadVoices = () => { voicesRef.current = window.speechSynthesis.getVoices(); };
                loadVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
            }, []);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            // Audio Functions
            const fastUnlockAudio = () => {
                if (!audioCtx.current) { audioCtx.current = new (window.AudioContext || window.webkitAudioContext)(); }
                if (audioCtx.current.state === 'suspended') { audioCtx.current.resume(); }
                const silentAudio = document.getElementById('silent-audio');
                if (silentAudio) { silentAudio.play().catch(() => {}); }
                window.speechSynthesis.cancel();
                if (window.speechSynthesis.paused) { window.speechSynthesis.resume(); }
                const unlockTTS = new SpeechSynthesisUtterance(" ");
                unlockTTS.volume = 0;
                window.speechSynthesis.speak(unlockTTS);
            };

            const playBeep = (freq = 440, duration = 0.1, type = 'sine', volume = 0.3) => {
                if (isMuted || !audioCtx.current) return;
                try {
                    const osc = audioCtx.current.createOscillator();
                    const gain = audioCtx.current.createGain();
                    osc.type = type; osc.connect(gain); gain.connect(audioCtx.current.destination);
                    osc.frequency.setValueAtTime(freq, audioCtx.current.currentTime);
                    gain.gain.setValueAtTime(volume, audioCtx.current.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.current.currentTime + duration);
                    osc.start(); osc.stop(audioCtx.current.currentTime + duration);
                } catch (e) {}
            };

            const speak = (text) => {
                if (isMuted) return;
                try {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = /[a-zA-Z]/.test(text) ? 'en-US' : 'ko-KR';
                    utterance.pitch = 1.25; utterance.rate = 1.05;
                    window.speechSynthesis.speak(utterance);
                } catch (e) {}
            };

            // Logic calculations
            const currentRecipe = recipes[selectedIdx] || recipes[0];
            const totalDuration = useMemo(() => currentRecipe?.steps.reduce((acc, s) => acc + s.duration, 0) || 0, [currentRecipe]);

            const getStepInfoAtTime = (time) => {
                if(!currentRecipe) return { idx: 0, remainingInStep: 0, totalInStep: 0 };
                let acc = 0;
                for (let i = 0; i < currentRecipe.steps.length; i++) {
                    const stepDuration = currentRecipe.steps[i].duration;
                    acc += stepDuration;
                    if (time < acc) return { idx: i, remainingInStep: acc - time, totalInStep: stepDuration };
                }
                return { idx: currentRecipe.steps.length - 1, remainingInStep: 0, totalInStep: currentRecipe.steps[currentRecipe.steps.length - 1].duration };
            };

            // Timer Loop
            useEffect(() => {
                if (status === 'countdown') {
                    const krCounts = ["", "일", "이", "삼", "사", "오"];
                    if (lastSpokenSec.current !== countdown) { speak(krCounts[countdown]); lastSpokenSec.current = countdown; }
                    const interval = setInterval(() => {
                        setCountdown(prev => {
                            if (prev <= 1) {
                                setStatus('running');
                                playBeep(880, 0.15, 'square', 0.2); setTimeout(() => playBeep(880, 0.1, 'square', 0.2), 200);
                                speak(currentRecipe.steps[0].name);
                                lastSpokenSec.current = -1; 
                                return 0;
                            }
                            const nextCount = prev - 1;
                            speak(krCounts[nextCount]); lastSpokenSec.current = nextCount;
                            return nextCount;
                        });
                    }, 1000);
                    return () => clearInterval(interval);
                }
                if (status === 'running') {
                    const start = Date.now() - (elapsedTime * 1000);
                    timerRef.current = setInterval(() => {
                        const now = (Date.now() - start) / 1000;
                        const { idx: stepIdx, remainingInStep, totalInStep } = getStepInfoAtTime(now);
                        if (stepIdx !== activeStepIdx && stepIdx < currentRecipe.steps.length) {
                            setActiveStepIdx(stepIdx);
                            playBeep(880, 0.15, 'square', 0.2); setTimeout(() => playBeep(880, 0.1, 'square', 0.2), 200);
                            speak(currentRecipe.steps[stepIdx].name);
                            lastSpokenSec.current = -1;
                        }
                        if (totalInStep >= 5 && remainingInStep <= 3.1 && remainingInStep > 0) {
                            const roundedRemaining = Math.ceil(remainingInStep);
                            if (roundedRemaining > 0 && roundedRemaining <= 3 && lastSpokenSec.current !== roundedRemaining) {
                                const krCounts = ["", "일", "이", "삼"];
                                speak(krCounts[roundedRemaining]); lastSpokenSec.current = roundedRemaining;
                            }
                        }
                        if (now >= totalDuration) {
                            setElapsedTime(totalDuration); setStatus('finished');
                            let delay = 0; [1, 2, 3].forEach(() => { setTimeout(() => playBeep(1200, 0.8, 'sine', 0.25), delay); delay += 800; });
                            speak("추출 완료");
                            clearInterval(timerRef.current);
                        } else {
                            setElapsedTime(now);
                        }
                    }, 50);
                    return () => clearInterval(timerRef.current);
                }
            }, [status, activeStepIdx, currentRecipe, elapsedTime, totalDuration]);

            // Database Actions (with local fallback)
            const handleSave = async () => {
                if (fbOps && user) {
                    const { db, appId, doc, updateDoc, addDoc, collection } = fbOps;
                    try {
                        if (editedRecipe.id) {
                            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'recipes', editedRecipe.id), editedRecipe);
                        } else {
                            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'recipes'), editedRecipe);
                        }
                        showToast("저장되었습니다.");
                    } catch (e) { showToast("저장 실패"); }
                } else {
                    if(editedRecipe.id) { setRecipes(prev => prev.map(r => r.id === editedRecipe.id ? editedRecipe : r)); }
                    else { setRecipes(prev => [...prev, {...editedRecipe, id: Date.now().toString()}]); }
                    showToast("저장되었습니다. (오프라인)");
                }
                setView('list');
            };

            const handleDelete = async () => {
                if (recipes.length <= 1) return;
                if (fbOps && user && editedRecipe.id) {
                    try {
                        await fbOps.deleteDoc(fbOps.doc(fbOps.db, 'artifacts', fbOps.appId, 'users', user.uid, 'recipes', editedRecipe.id));
                        showToast("삭제되었습니다.");
                    } catch (e) { showToast("삭제 실패"); }
                } else {
                    setRecipes(prev => prev.filter(r => r.id !== editedRecipe.id));
                    showToast("삭제되었습니다.");
                }
                setSelectedIdx(0); setView('list');
            };

            // Sharing Functions
            const exportRecipe = (e, recipe) => {
                e.stopPropagation();
                const { id, ...dataToShare } = recipe; // Remove DB ID before sharing
                const code = btoa(encodeURIComponent(JSON.stringify(dataToShare)));
                
                const textArea = document.createElement("textarea");
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("레시피 코드가 복사되었습니다! 친구에게 공유하세요.");
                } catch (err) {
                    showToast("코드 복사에 실패했습니다.");
                }
                document.body.removeChild(textArea);
            };

            const handleImport = async () => {
                if (!importCode.trim()) return;
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(importCode.trim())));
                    if(decoded.name && decoded.steps) {
                        if (fbOps && user) {
                            await fbOps.addDoc(fbOps.collection(fbOps.db, 'artifacts', fbOps.appId, 'users', user.uid, 'recipes'), decoded);
                        } else {
                            setRecipes(prev => [...prev, {...decoded, id: Date.now().toString()}]);
                        }
                        showToast("새 레시피를 성공적으로 추가했습니다!");
                        setShowImportModal(false);
                        setImportCode('');
                    } else {
                        showToast("유효하지 않은 레시피 코드입니다.");
                    }
                } catch (e) {
                    showToast("코드 해석 오류. 올바른 코드인지 확인해주세요.");
                }
            };

            const ProgressGraph = ({ recipe, time, showIndicator = true }) => {
                if (!recipe || !recipe.steps || recipe.steps.length === 0) return null;
                const recipeTotal = recipe.steps.reduce((acc, s) => acc + s.duration, 0);
                let currentX = 20;
                const points = [`20,${90 - (recipe.steps[0].pressure / 11) * 80}`];
                recipe.steps.forEach(s => {
                    const stepW = (s.duration / recipeTotal) * 360;
                    const endY = 90 - ((s.pressureEnd || s.pressure) / 11) * 80;
                    points.push(`${currentX + stepW},${endY}`); currentX += stepW;
                });
                const progressX = 20 + (time / recipeTotal) * 360;
                return (
                    <div className="w-full bg-slate-900/50 rounded-2xl p-2 border border-white/5">
                        <svg viewBox="0 0 400 100" className="w-full h-auto">
                            {[0, 2, 4, 6, 8, 10].map(v => <line key={v} x1="20" y1={90-(v/11)*80} x2="380" y2={90-(v/11)*80} stroke="#1e293b" strokeWidth="1" />)}
                            <polyline fill="none" stroke="#3b82f6" strokeWidth="3" points={points.join(' ')} strokeLinejoin="round" />
                            {showIndicator && time > 0 && <line x1={progressX} y1="10" x2={progressX} y2="90" stroke="#f43f5e" strokeWidth="2" strokeDasharray="4" />}
                        </svg>
                    </div>
                );
            };

            if (view === 'list') {
                return (
                    <div className="min-h-screen safe-top safe-bottom px-6 py-8 flex flex-col items-center">
                        <div className="w-full max-w-md">
                            <div className="flex justify-between items-center mb-10">
                                <h1 className="text-3xl font-black bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent italic">FLAIR 58</h1>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowImportModal(true)} className="p-3 bg-slate-800 rounded-2xl text-slate-300 hover:text-white transition-colors">
                                        <Icon name="download" />
                                    </button>
                                    <button onClick={() => {
                                        setEditedRecipe({ name: 'New Recipe', dose: 18, yield: 36, temp: 93, 
                                            steps: [
                                                { name: 'Pre-infusion', duration: 8, pressure: 2, pressureEnd: 3 },
                                                { name: 'Ramp-up', duration: 3, pressure: 3, pressureEnd: 9 },
                                                { name: 'Main-extraction', duration: 10, pressure: 9, pressureEnd: 9 },
                                                { name: 'Tapering', duration: 8, pressure: 9, pressureEnd: 4 }
                                            ] 
                                        });
                                        setSelectedIdx(recipes.length); setView('detail');
                                    }} className="p-3 bg-blue-600 rounded-2xl shadow-lg shadow-blue-900/20 text-white"><Icon name="plus" /></button>
                                </div>
                            </div>
                            <div className="space-y-4">
                                {recipes.map((r, i) => (
                                    <div key={r.id || i} onClick={() => { setSelectedIdx(i); setEditedRecipe({...r}); setView('detail'); }} className="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-6 active:scale-95 transition-transform cursor-pointer">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h2 className="text-xl font-bold mb-2 text-white">{r.name}</h2>
                                                <div className="flex gap-4 text-xs font-bold text-slate-400 uppercase tracking-widest">
                                                    <span className="bg-slate-800 px-2 py-0.5 rounded text-white">{r.dose}g</span>
                                                    <span className="bg-blue-900/30 px-2 py-0.5 rounded text-blue-400">{r.yield}g</span>
                                                    <span className="bg-rose-900/30 px-2 py-0.5 rounded text-rose-400">{r.temp}°C</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-3 items-center">
                                                <button onClick={(e) => exportRecipe(e, r)} className="p-2 bg-slate-800 rounded-xl text-slate-400 hover:text-white active:scale-90 transition-all">
                                                    <Icon name="share-2" size={18} />
                                                </button>
                                                <Icon name="chevron-right" size={20} className="text-slate-600" />
                                            </div>
                                        </div>
                                        <ProgressGraph recipe={r} time={0} showIndicator={false} />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Import Modal */}
                        {showImportModal && (
                            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 backdrop-blur-sm">
                                <div className="bg-slate-900 border border-slate-800 rounded-3xl p-6 w-full max-w-sm">
                                    <h3 className="text-xl font-bold mb-2 text-white">레시피 불러오기</h3>
                                    <p className="text-xs text-slate-400 mb-6 leading-relaxed">공유받은 레시피 코드를 아래 텍스트 박스에 붙여넣고 버튼을 누르세요.</p>
                                    <textarea 
                                        className="w-full bg-slate-800 text-slate-300 rounded-xl p-4 mb-6 focus:outline-none focus:ring-1 ring-blue-500 min-h-[120px] break-all font-mono text-xs"
                                        placeholder="이곳을 터치하여 코드 붙여넣기..."
                                        value={importCode}
                                        onChange={e => setImportCode(e.target.value)}
                                    />
                                    <div className="flex gap-3">
                                        <button onClick={() => { setShowImportModal(false); setImportCode(''); }} className="flex-1 py-4 bg-slate-800 rounded-2xl font-bold text-white">취소</button>
                                        <button onClick={handleImport} className="flex-1 py-4 bg-blue-600 rounded-2xl font-bold text-white">불러오기</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {toast && <div className="fixed bottom-10 bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-2xl z-50 animate-bounce">{toast}</div>}
                    </div>
                );
            }

            if (view === 'detail') {
                return (
                    <div className="min-h-screen safe-top safe-bottom px-6 py-8 flex flex-col items-center text-white">
                        <div className="w-full max-w-md pb-40">
                            <div className="flex justify-between items-center mb-6">
                                <button onClick={() => setView('list')} className="p-2 text-slate-400"><Icon name="chevron-left" size={32}/></button>
                                <div className="flex gap-2">
                                    <button onClick={() => setIsMuted(!isMuted)} className="p-3 bg-slate-900 rounded-xl border border-slate-800"><Icon name={isMuted ? "volume-x" : "volume-2"} size={20}/></button>
                                    <button onClick={handleDelete} className="p-3 bg-rose-500/10 text-rose-500 rounded-xl"><Icon name="trash-2" size={20}/></button>
                                </div>
                            </div>
                            <input className="w-full bg-transparent text-3xl font-black mb-8 focus:outline-none border-b border-white/10 pb-2 text-white" value={editedRecipe.name} onChange={e => setEditedRecipe({...editedRecipe, name: e.target.value})} />
                            <div className="grid grid-cols-3 gap-3 mb-8">
                                <div className="bg-slate-900 p-4 rounded-3xl border border-slate-800 text-center">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Dose</div>
                                    <input type="number" className="w-full bg-transparent font-mono text-2xl font-black text-white text-center focus:outline-none" value={editedRecipe.dose} onChange={e => setEditedRecipe({...editedRecipe, dose: Number(e.target.value)})} />
                                </div>
                                <div className="bg-slate-900 p-4 rounded-3xl border border-slate-800 text-center">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Yield</div>
                                    <input type="number" className="w-full bg-transparent font-mono text-2xl font-black text-blue-400 text-center focus:outline-none" value={editedRecipe.yield} onChange={e => setEditedRecipe({...editedRecipe, yield: Number(e.target.value)})} />
                                </div>
                                <div className="bg-slate-900 p-4 rounded-3xl border border-slate-800 text-center">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-1">Temp</div>
                                    <input type="number" className="w-full bg-transparent font-mono text-2xl font-black text-rose-400 text-center focus:outline-none" value={editedRecipe.temp} onChange={e => setEditedRecipe({...editedRecipe, temp: Number(e.target.value)})} />
                                </div>
                            </div>
                            <div className="mb-8"><ProgressGraph recipe={editedRecipe} time={0} showIndicator={false} /></div>
                            <div className="space-y-4">
                                {editedRecipe.steps.map((s, idx) => (
                                    <div key={idx} className="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                                        <div className="flex gap-2 mb-4">
                                            <input className="flex-1 bg-slate-800 rounded-xl px-4 py-3 text-sm font-bold text-white focus:outline-none" value={s.name} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].name = e.target.value; setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            <div className="flex items-center gap-2 bg-slate-800 px-3 rounded-xl">
                                                <input type="number" className="w-8 bg-transparent text-center font-mono text-blue-400 font-bold focus:outline-none" value={s.duration} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].duration = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                                <span className="text-[10px] text-slate-500 font-bold">S</span>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <div>
                                                <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1"><span>START PRESSURE</span><span>{s.pressure} BAR</span></div>
                                                <input type="range" min="0" max="11" step="0.5" value={s.pressure} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].pressure = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            </div>
                                            <div>
                                                <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-1"><span>END PRESSURE</span><span>{s.pressureEnd || s.pressure} BAR</span></div>
                                                <input type="range" min="0" max="11" step="0.5" value={s.pressureEnd || s.pressure} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].pressureEnd = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => setEditedRecipe({...editedRecipe, steps: [...editedRecipe.steps, { name: 'Step', duration: 10, pressure: 6, pressureEnd: 6 }]})} className="w-full py-5 border-2 border-dashed border-slate-800 rounded-3xl text-slate-500 font-bold hover:bg-slate-900/50 transition-colors">+ 단계 추가</button>
                            </div>
                            <div className="fixed bottom-0 left-0 w-full p-6 safe-bottom bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent z-40">
                                <div className="max-w-md mx-auto flex gap-3">
                                    <button onClick={handleSave} className="flex-1 py-5 bg-slate-800 rounded-[2rem] font-bold text-white active:scale-95 transition-transform">저장</button>
                                    <button onClick={() => { fastUnlockAudio(); setElapsedTime(0); setActiveStepIdx(0); setCountdown(5); lastSpokenSec.current = -1; setStatus('countdown'); setView('active'); }} className="flex-[2] py-5 bg-blue-600 rounded-[2rem] font-black text-xl text-white shadow-2xl active:scale-95 transition-transform">추출 시작</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const activeStep = currentRecipe?.steps[activeStepIdx];
            return (
                <div className="min-h-screen safe-top safe-bottom p-8 flex flex-col items-center bg-slate-950 text-white overflow-hidden">
                    <div className="w-full max-w-md h-full flex flex-col">
                        <header className="flex justify-between items-start mb-4">
                            <div className="space-y-2">
                                <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div><h2 className="text-sm font-bold uppercase text-slate-300">{currentRecipe?.name}</h2></div>
                                <div className="flex gap-4 text-xs font-mono text-slate-400 font-black"><span>{currentRecipe?.dose}g</span><span>{currentRecipe?.yield}g</span><span>{currentRecipe?.temp}°C</span></div>
                            </div>
                            <button onClick={() => { setStatus('idle'); setElapsedTime(0); setView('list'); }} className="p-3 bg-slate-900 rounded-full text-slate-400"><Icon name="rotate-ccw" size={18} /></button>
                        </header>
                        
                        <main className="flex-1 flex flex-col justify-center">
                            {status === 'countdown' ? (
                                <div className="text-center">
                                    <div className="text-[12rem] font-black text-blue-500 leading-none drop-shadow-[0_0_30px_rgba(59,130,246,0.3)]">{countdown}</div>
                                    <div className="text-xl font-bold tracking-[0.5em] text-slate-600 uppercase mt-4">준비하세요</div>
                                </div>
                            ) : (
                                <div className="space-y-12">
                                    <div className="text-center">
                                        <div className="text-xl font-bold text-slate-400 uppercase tracking-widest mb-6 bg-slate-900/50 py-2 rounded-full border border-white/5">{activeStep?.name}</div>
                                        <div className="pressure-container">
                                            <div className="flex items-center gap-3">
                                                <div className="text-[7rem] font-black leading-none text-white tabular-nums">{activeStep?.pressure}</div>
                                                {activeStep?.pressureEnd && activeStep.pressureEnd !== activeStep.pressure && (
                                                    <><Icon name="arrow-right" size={40} className="text-slate-600" /><div className="text-[7rem] font-black leading-none text-white tabular-nums">{activeStep.pressureEnd}</div></>
                                                )}
                                                <div className="text-2xl font-black text-cyan-500 self-end mb-2 ml-1">BAR</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-10">
                                        <ProgressGraph recipe={currentRecipe} time={elapsedTime} />
                                        <div className="flex justify-between items-end px-2">
                                            <div className="text-7xl font-mono font-bold text-white tabular-nums">{elapsedTime.toFixed(1)}<span className="text-2xl text-slate-600 ml-1">s</span></div>
                                            <div className="text-right">
                                                <div className="text-[10px] font-black text-slate-500 uppercase mb-1">Remaining</div>
                                                <div className="text-3xl font-mono text-slate-300 tabular-nums">{(totalDuration - elapsedTime).toFixed(1)}s</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>

                        <footer className="mt-8 py-8">
                            {status === 'finished' ? (
                                <button onClick={() => { setStatus('idle'); setElapsedTime(0); setView('list'); }} className="w-full py-6 bg-blue-600 rounded-[2.5rem] text-2xl font-black text-white shadow-2xl active:scale-95 transition-transform">DONE</button>
                            ) : (
                                <div className="grid grid-cols-4 gap-2">
                                    {currentRecipe?.steps.map((_, i) => (
                                        <div key={i} className={`h-1.5 rounded-full transition-all duration-300 ${i === activeStepIdx ? 'bg-blue-500 shadow-lg shadow-blue-500/50' : i < activeStepIdx ? 'bg-slate-700' : 'bg-slate-900'}`} />
                                    ))}
                                </div>
                            )}
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


