<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Espresso Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #020617;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        input[type="range"] { -webkit-appearance: none; background: transparent; cursor: pointer; }
        input[type="range"]::-webkit-slider-runnable-track { background: #1e293b; height: 6px; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; background: #3b82f6; border-radius: 50%; margin-top: -7px; border: 2px solid #020617; }
        input { color: white !important; }
        
        .pressure-container {
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <audio id="silent-audio" preload="auto" style="display:none;" loop>
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const spanRef = useRef(null);
            useEffect(() => {
                if (spanRef.current && window.lucide) {
                    spanRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({
                        root: spanRef.current,
                        attrs: { width: size, height: size, 'stroke-width': 2 }
                    });
                }
            }, [name, size]);
            return <span ref={spanRef} className={`inline-flex items-center justify-center ${className}`}></span>;
        };

        const App = () => {
            const [view, setView] = useState('list');
            const [toast, setToast] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const [recipes, setRecipes] = useState([
                {
                    id: 1,
                    name: 'Classic Flair 58 Profile',
                    dose: 18,
                    yield: 36,
                    temp: 93,
                    steps: [
                        { name: 'Pre-infusion', duration: 10, pressure: 2, pressureEnd: 2 },
                        { name: 'Ramp Up', duration: 3, pressure: 2, pressureEnd: 9 },
                        { name: 'Main Extraction', duration: 20, pressure: 9, pressureEnd: 9 },
                        { name: 'Tapering', duration: 7, pressure: 9, pressureEnd: 6 }
                    ]
                }
            ]);
            const [selectedIdx, setSelectedIdx] = useState(0);
            const [editedRecipe, setEditedRecipe] = useState(null);
            const [status, setStatus] = useState('idle');
            const [countdown, setCountdown] = useState(5);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [activeStepIdx, setActiveStepIdx] = useState(0);
            
            const timerRef = useRef(null);
            const audioCtx = useRef(null);
            const voicesRef = useRef([]);

            const currentRecipe = recipes[selectedIdx] || recipes[0];

            useEffect(() => {
                const loadVoices = () => { voicesRef.current = window.speechSynthesis.getVoices(); };
                loadVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
            }, []);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            // iOS 무음 모드 우회 핵심 로직
            const unlockAudioContext = () => {
                // 1. Web Audio API 깨우기
                if (!audioCtx.current) {
                    audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.current.state === 'suspended') {
                    audioCtx.current.resume();
                }

                // 2. HTML5 Audio 깨우기 (배경 무음 트랙)
                const silentAudio = document.getElementById('silent-audio');
                if (silentAudio) {
                    silentAudio.play().catch(() => {});
                }

                // 3. TTS 초기화 (더미 발화)
                window.speechSynthesis.cancel();
                if (window.speechSynthesis.paused) {
                    window.speechSynthesis.resume();
                }
                const dummy = new SpeechSynthesisUtterance("");
                dummy.volume = 0;
                window.speechSynthesis.speak(dummy);
            };

            const speak = (text) => {
                if (isMuted) return;
                try {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    const isEnglish = /[a-zA-Z]/.test(text);
                    if (isEnglish) {
                        utterance.lang = 'en-US';
                        const v = voicesRef.current.find(v => v.lang.includes('en') && v.name.includes('Samantha'));
                        if (v) utterance.voice = v;
                    } else {
                        utterance.lang = 'ko-KR';
                        const koVoices = voicesRef.current.filter(v => v.lang.includes('ko'));
                        let v = koVoices.find(v => v.name.includes('Sora') || v.name.includes('SunHi'));
                        if (!v && koVoices.length > 0) v = koVoices[0];
                        if (v) utterance.voice = v;
                    }
                    utterance.pitch = 1.2;
                    utterance.rate = 1.1;
                    window.speechSynthesis.speak(utterance);
                } catch (e) {}
            };

            const playBeep = (freq = 440, duration = 0.1) => {
                if (isMuted || !audioCtx.current) return;
                try {
                    const osc = audioCtx.current.createOscillator();
                    const gain = audioCtx.current.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.current.destination);
                    osc.frequency.setValueAtTime(freq, audioCtx.current.currentTime);
                    gain.gain.setValueAtTime(0.2, audioCtx.current.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.current.currentTime + duration);
                    osc.start();
                    osc.stop(audioCtx.current.currentTime + duration);
                } catch (e) {}
            };

            useEffect(() => {
                if (status === 'countdown') {
                    const krCounts = ["", "일", "이", "삼", "사", "오"];
                    speak(krCounts[countdown]);
                    const interval = setInterval(() => {
                        setCountdown(prev => {
                            if (prev <= 1) {
                                setStatus('running');
                                speak(currentRecipe.steps[0].name);
                                return 0;
                            }
                            const next = prev - 1;
                            speak(krCounts[next]);
                            return next;
                        });
                    }, 1000);
                    return () => clearInterval(interval);
                }
                if (status === 'running') {
                    const totalDuration = currentRecipe.steps.reduce((acc, s) => acc + s.duration, 0);
                    const start = Date.now() - (elapsedTime * 1000);
                    timerRef.current = setInterval(() => {
                        const now = (Date.now() - start) / 1000;
                        let acc = 0;
                        let stepIdx = 0;
                        for (let i = 0; i < currentRecipe.steps.length; i++) {
                            acc += currentRecipe.steps[i].duration;
                            if (now < acc) { stepIdx = i; break; }
                            stepIdx = currentRecipe.steps.length - 1;
                        }
                        
                        if (stepIdx !== activeStepIdx) {
                            setActiveStepIdx(stepIdx);
                            playBeep(880, 0.2);
                            speak(currentRecipe.steps[stepIdx].name);
                        }
                        
                        if (now >= totalDuration) {
                            setElapsedTime(totalDuration);
                            setStatus('finished');
                            speak("추출 완료");
                            clearInterval(timerRef.current);
                        } else {
                            setElapsedTime(now);
                        }
                    }, 50);
                    return () => clearInterval(timerRef.current);
                }
            }, [status, activeStepIdx, currentRecipe]);

            const handleStart = () => {
                // 1. 상태 즉시 변경 (동기적)
                setElapsedTime(0);
                setActiveStepIdx(0);
                setCountdown(5);
                setStatus('countdown');
                setView('active');

                // 2. 오디오 세션 즉시 활성화 (사용자 터치 시점)
                unlockAudioContext();
            };

            const ProgressGraph = ({ recipe, time, showIndicator = true }) => {
                if (!recipe) return null;
                const recipeTotal = recipe.steps.reduce((acc, s) => acc + s.duration, 0);
                let currentX = 20;
                const points = [];
                points.push(`20,${90 - (recipe.steps[0].pressure / 11) * 80}`);
                recipe.steps.forEach(s => {
                    const stepW = (s.duration / recipeTotal) * 360;
                    points.push(`${currentX + stepW},${90 - ((s.pressureEnd || s.pressure) / 11) * 80}`);
                    currentX += stepW;
                });
                const progressX = 20 + (time / recipeTotal) * 360;
                return (
                    <div className="w-full bg-slate-900/50 rounded-2xl p-2 border border-white/5">
                        <svg viewBox="0 0 400 100" className="w-full h-auto">
                            {[0, 2, 4, 6, 8, 10].map(v => <line key={v} x1="20" y1={90-(v/11)*80} x2="380" y2={90-(v/11)*80} stroke="#1e293b" strokeWidth="1" />)}
                            <polyline fill="none" stroke="#3b82f6" strokeWidth="3" points={points.join(' ')} strokeLinejoin="round" />
                            {showIndicator && time > 0 && <line x1={progressX} y1="10" x2={progressX} y2="90" stroke="#f43f5e" strokeWidth="2" strokeDasharray="4" />}
                        </svg>
                    </div>
                );
            };

            if (view === 'list') {
                return (
                    <div className="min-h-screen safe-top safe-bottom px-6 py-8 flex flex-col items-center">
                        <div className="w-full max-w-md">
                            <h1 className="text-3xl font-black bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent italic mb-10">FLAIR 58</h1>
                            <div className="space-y-4">
                                {recipes.map((r, i) => (
                                    <div key={r.id} onClick={() => { setSelectedIdx(i); setEditedRecipe({...r}); setView('detail'); }} className="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-6 active:scale-95 transition-transform cursor-pointer">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h2 className="text-xl font-bold mb-2 text-white">{r.name}</h2>
                                                <div className="flex gap-4 text-xs font-bold text-slate-400 uppercase tracking-widest">
                                                    <span className="bg-slate-800 px-2 py-0.5 rounded text-white">{r.dose}g</span>
                                                    <span className="bg-blue-900/30 px-2 py-0.5 rounded text-blue-400">{r.yield}g</span>
                                                </div>
                                            </div>
                                            <Icon name="chevron-right" size={20} className="text-slate-600" />
                                        </div>
                                        <ProgressGraph recipe={r} time={0} showIndicator={false} />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'detail') {
                return (
                    <div className="min-h-screen safe-top safe-bottom px-6 py-8 flex flex-col items-center text-white">
                        <div className="w-full max-w-md pb-40">
                            <button onClick={() => setView('list')} className="p-2 text-slate-400 mb-6"><Icon name="chevron-left" size={32}/></button>
                            <input className="w-full bg-transparent text-3xl font-black mb-8 focus:outline-none text-white border-b border-white/10 pb-2" value={editedRecipe.name} onChange={e => setEditedRecipe({...editedRecipe, name: e.target.value})} />
                            <div className="mb-8"><ProgressGraph recipe={editedRecipe} time={0} showIndicator={false} /></div>
                            <div className="space-y-4">
                                {editedRecipe.steps.map((s, idx) => (
                                    <div key={idx} className="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                                        <div className="flex gap-2 mb-4 text-sm font-bold">
                                            <input className="flex-1 bg-slate-800 rounded-xl px-4 py-3" value={s.name} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].name = e.target.value; setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            <div className="flex items-center gap-2 bg-slate-800 px-3 rounded-xl">
                                                <input type="number" className="w-8 bg-transparent text-blue-400" value={s.duration} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].duration = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                                <span>S</span>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <div>
                                                <div className="flex justify-between text-[10px] text-slate-500 mb-1"><span>START PRESSURE</span><span>{s.pressure} BAR</span></div>
                                                <input type="range" min="0" max="11" step="0.5" className="w-full" value={s.pressure} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].pressure = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            </div>
                                            <div>
                                                <div className="flex justify-between text-[10px] text-slate-500 mb-1"><span>END PRESSURE</span><span>{s.pressureEnd || s.pressure} BAR</span></div>
                                                <input type="range" min="0" max="11" step="0.5" className="w-full" value={s.pressureEnd || s.pressure} onChange={e => { const ns = [...editedRecipe.steps]; ns[idx].pressureEnd = Number(e.target.value); setEditedRecipe({...editedRecipe, steps: ns}); }} />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="fixed bottom-0 left-0 w-full p-6 safe-bottom bg-gradient-to-t from-slate-950 to-transparent">
                                <div className="max-w-md mx-auto flex gap-3">
                                    <button onClick={() => { setRecipes(prev => { const n = [...prev]; n[selectedIdx] = editedRecipe; return n; }); setView('list'); }} className="flex-1 py-5 bg-slate-800 rounded-[2rem] font-bold">저장</button>
                                    <button 
                                        onPointerDown={handleStart}
                                        className="flex-[2] py-5 bg-blue-600 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95 transition-transform"
                                    >추출 시작</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const activeStep = currentRecipe.steps[activeStepIdx];
            const totalDuration = currentRecipe.steps.reduce((acc, s) => acc + s.duration, 0);

            return (
                <div className="min-h-screen safe-top safe-bottom p-8 flex flex-col items-center text-white bg-slate-950">
                    <div className="w-full max-w-md h-full flex flex-col">
                        <header className="flex justify-between mb-4">
                            <h2 className="text-sm font-bold uppercase text-slate-300">{currentRecipe.name}</h2>
                            <button onClick={() => { setStatus('idle'); setView('list'); }} className="p-3 bg-slate-900 rounded-full"><Icon name="rotate-ccw" size={18} /></button>
                        </header>
                        
                        <main className="flex-1 flex flex-col justify-center">
                            {status === 'countdown' ? (
                                <div className="text-center">
                                    <div className="text-[12rem] font-black text-blue-500 leading-none">{countdown}</div>
                                    <div className="text-xl font-bold tracking-[0.5em] text-slate-600 uppercase mt-4">준비하세요</div>
                                </div>
                            ) : (
                                <div className="space-y-12">
                                    <div className="text-center">
                                        <div className="text-xl font-bold text-slate-400 uppercase tracking-widest mb-6 bg-slate-900/50 py-2 rounded-full border border-white/5">{activeStep?.name}</div>
                                        <div className="pressure-container">
                                            <div className="flex items-center gap-3">
                                                <div className="text-[7rem] font-black leading-none">{activeStep?.pressure}</div>
                                                {activeStep?.pressureEnd && activeStep.pressureEnd !== activeStep.pressure && (
                                                    <><Icon name="arrow-right" size={40} className="text-slate-600" /><div className="text-[7rem] font-black leading-none">{activeStep.pressureEnd}</div></>
                                                )}
                                                <div className="text-2xl font-black text-cyan-500 self-end mb-2">BAR</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-10">
                                        <ProgressGraph recipe={currentRecipe} time={elapsedTime} />
                                        <div className="flex justify-between items-end px-2">
                                            <div className="text-7xl font-mono font-bold tabular-nums">{elapsedTime.toFixed(1)}<span className="text-2xl text-slate-600 ml-1">s</span></div>
                                            <div className="text-right">
                                                <div className="text-3xl font-mono text-slate-300 tabular-nums">{(totalDuration - elapsedTime).toFixed(1)}s</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                        
                        <footer className="mt-8 py-8">
                            {status === 'finished' && (
                                <button onClick={() => { setStatus('idle'); setView('list'); }} className="w-full py-6 bg-blue-600 rounded-[2.5rem] text-2xl font-black">DONE</button>
                            )}
                        </footer>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
